<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Perceptrón Visual</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 30px;
    }
    canvas {
      max-width: 500px;
      border: 1px solid #ccc;
      background-color: #f9f9f9;
    }
    label, input, select, button {
      margin: 5px;
      padding: 5px;
      font-size: 1rem;
    }
    .visualization-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 20px;
      margin-top: 20px;
    }
    .perceptron-diagram svg {
      z-index: 1;
    }
    .neuron {
      z-index: 2;
    }
    .connection {
      stroke: #333;
      stroke-width: 2;
    }
    svg {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Entrenamiento del Perceptrón</h1>

  <label for="dataset">Selecciona un dataset:</label>
  <select id="dataset">
    <option value="and">AND</option>
    <option value="xor">XOR</option>
  </select><br>

  <label for="eta">Tasa de aprendizaje (η):</label>
  <input type="number" id="eta" step="0.01" value="0.1" /><br>

  <label for="cota">Cantidad máxima de iteraciones:</label>
  <input type="number" id="cota" value="100" /><br>

  <button onclick="iniciarEntrenamiento()">Iniciar entrenamiento</button>

  <p id="resultado"></p>

  <div class="visualization-container">
    <canvas id="grafico" width="400" height="400"></canvas>

    <div class="perceptron-diagram">
      <svg width="300" height="200">
        <line id="line0" class="connection" x1="50" y1="50" x2="250" y2="100" />
        <line id="line1" class="connection" x1="50" y1="100" x2="250" y2="100" />
        <line id="line2" class="connection" x1="50" y1="150" x2="250" y2="100" />

        <circle class="neuron" cx="50" cy="50" r="20" fill="#ddd" />
        <circle class="neuron" cx="50" cy="100" r="20" fill="#ddd" />
        <circle class="neuron" cx="50" cy="150" r="20" fill="#ddd" />
        <circle class="neuron" cx="250" cy="100" r="20" fill="#ccc" />

        <text id="peso0" x="140" y="45" font-size="12"></text>
        <text id="peso1" x="140" y="95" font-size="12"></text>
        <text id="peso2" x="140" y="145" font-size="12"></text>
      </svg>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("grafico");
    const ctx = canvas.getContext("2d");

    const datasets = {
      and: {
        x: [[-1, 1], [1, -1], [-1, -1], [1, 1]],
        y: [-1, -1, -1, 1]
      },
      xor: {
        x: [[-1, 1], [1, -1], [-1, -1], [1, 1]],
        y: [1, 1, -1, -1]
      }
    };

    function signo(h) {
      return h >= 0 ? 1 : -1;
    }

    function errorAbsoluto(x, y, w) {
      let error = 0;
      for (let i = 0; i < x.length; i++) {
        const entrada = [...x[i], 1];
        const salida = signo(dot(entrada, w));
        error += Math.abs(y[i] - salida);
      }
      return error;
    }

    function dot(a, b) {
      return a.reduce((acc, val, i) => acc + val * b[i], 0);
    }

    function graficar(x, y, w, iter) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.translate(200, 200);
      ctx.scale(50, -50);

      ctx.beginPath();
      ctx.strokeStyle = "#ccc";
      for (let xg = -4; xg <= 4; xg++) {
        ctx.moveTo(xg, -4);
        ctx.lineTo(xg, 4);
      }
      for (let yg = -4; yg <= 4; yg++) {
        ctx.moveTo(-4, yg);
        ctx.lineTo(4, yg);
      }
      ctx.stroke();

      for (let i = 0; i < x.length; i++) {
        ctx.beginPath();
        ctx.arc(x[i][0], x[i][1], 0.1, 0, 2 * Math.PI);
        ctx.fillStyle = y[i] === 1 ? "green" : "red";
        ctx.fill();
      }

      if (w[1] !== 0) {
        ctx.beginPath();
        ctx.moveTo(-2, -(w[0] * -2 + w[2]) / w[1]);
        ctx.lineTo(2, -(w[0] * 2 + w[2]) / w[1]);
        ctx.strokeStyle = "black";
        ctx.lineWidth = 0.05;
        ctx.stroke();
      }

      ctx.restore();
    }

    function actualizarGrafos(w) {
      for (let i = 0; i < 3; i++) {
        document.getElementById(`peso${i}`).textContent = `w${i}: ${w[i].toFixed(2)}`;
      }
    }

    async function perceptronSimple(x, y, eta, cota) {
      let w = [0, 0, 1];
      let error = Infinity;
      let i = 0;
      const xExt = x.map(p => [...p, 1]);
      let errorMin = Infinity;
      let wMin = [...w];

      while (error > 0 && i < cota) {
        let errorIteracion = 0;

        for (let idx = 0; idx < x.length; idx++) {
          const salida = signo(dot(xExt[idx], w));
          const delta = xExt[idx].map(val => eta * (y[idx] - salida) * val);
          w = w.map((wi, j) => wi + delta[j]);
          const salidaFinal = signo(dot(xExt[idx], w));
          errorIteracion += Math.abs(y[idx] - salidaFinal);

          graficar(x, y, w, i);
          actualizarGrafos(w);
          await new Promise(res => setTimeout(res, 150));
        }

        if (errorIteracion < errorMin) {
          errorMin = errorIteracion;
          wMin = [...w];
        }

        if (errorIteracion === 0) break;
        i++;
      }

      graficar(x, y, wMin, i);
      actualizarGrafos(wMin);
      document.getElementById("resultado").innerText = `Pesos finales tras ${i} iteraciones: [${wMin.map(n => n.toFixed(2)).join(", ")}] con error ${errorMin}`;
    }

    function iniciarEntrenamiento() {
      const tipo = document.getElementById("dataset").value;
      const eta = parseFloat(document.getElementById("eta").value);
      const cota = parseInt(document.getElementById("cota").value);

      const datos = datasets[tipo];
      perceptronSimple(datos.x, datos.y, eta, cota);
    }
  </script>
</body>
</html>
